<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walkability Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --orange-50: #fff7ed;
            --orange-100: #ffedd5;
            --orange-200: #fed7aa;
            --orange-300: #fdba74;
            --orange-400: #fb923c;
            --orange-500: #f97316;
            --orange-600: #ea580c;
            --orange-700: #c2410c;
            --amber-500: #f59e0b;
            --amber-600: #d97706;
        }

        body {
            background: linear-gradient(135deg, var(--orange-50) 0%, #fef3c7 100%);
            min-height: 100vh;
        }

        .bg-orange-gradient {
            background: linear-gradient(135deg, var(--orange-500) 0%, var(--amber-500) 100%);
        }

        .text-orange-gradient {
            background: linear-gradient(135deg, var(--orange-600) 0%, var(--orange-500) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .border-orange {
            border-color: var(--orange-200) !important;
        }

        .btn-orange {
            background: linear-gradient(135deg, var(--orange-500) 0%, var(--amber-500) 100%);
            border: none;
            color: white;
        }

        .btn-orange:hover {
            background: linear-gradient(135deg, var(--orange-600) 0%, var(--amber-600) 100%);
            color: white;
        }

        .btn-outline-orange {
            border-color: var(--orange-300);
            color: var(--orange-600);
        }

        .btn-outline-orange:hover {
            background-color: var(--orange-100);
            border-color: var(--orange-300);
            color: var(--orange-600);
        }

        .card-header-orange {
            background: linear-gradient(135deg, var(--orange-500) 0%, var(--amber-500) 100%);
            color: white;
        }

        .text-orange-600 {
            color: var(--orange-600) !important;
        }

        .text-orange-700 {
            color: var(--orange-700) !important;
        }

        .bg-orange-50 {
            background-color: var(--orange-50) !important;
        }

        .icon-orange {
            color: var(--orange-500);
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--orange-500) 0%, var(--amber-500) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            border: 4px solid var(--orange-300);
            box-shadow: 0 8px 25px rgba(249, 115, 22, 0.3);
        }

        .score-floating {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1050;
            transition: all 0.3s ease;
        }

        .score-floating .score-circle {
            width: 60px;
            height: 60px;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .score-floating.expanded .score-circle {
            width: 80px;
            height: 80px;
            font-size: 1.5rem;
        }

        .progress-orange {
            background-color: var(--orange-100);
        }

        .progress-orange .progress-bar {
            background: linear-gradient(135deg, var(--orange-500) 0%, var(--amber-500) 100%);
        }

        .badge-walker-paradise {
            background-color: #22c55e;
        }

        .badge-very-walkable {
            background-color: #84cc16;
        }

        .badge-somewhat-walkable {
            background-color: #eab308;
        }

        .badge-car-dependent {
            background-color: #f97316;
        }

        .badge-not-walkable {
            background-color: #ef4444;
        }

        #map {
            height: 400px;
            border-radius: 0.5rem;
            border: 2px solid var(--orange-200);
        }

        .category-item {
            padding: 0.75rem;
            margin: 0.25rem 0;
            background-color: var(--orange-50);
            border: 1px solid var(--orange-200);
            border-radius: 0.5rem;
        }

        .score-detail {
            background: linear-gradient(135deg, var(--orange-100) 0%, #fef3c7 100%);
            border: 2px solid var(--orange-200);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .nearby-item {
            background-color: white;
            border: 1px solid var(--orange-200);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.5rem 0;
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <!-- Header -->
        <div class="d-flex align-items-center gap-3 mb-4">
            <a href="/" class="btn btn-outline-orange">
                <i class="fas fa-arrow-left me-2"></i>Back
            </a>
            <div class="d-flex align-items-center gap-2">
                <i class="fas fa-award fa-2x icon-orange"></i>
                <h1 class="text-orange-gradient mb-0">Your Walkability Results</h1>
            </div>
        </div>

        <!-- Location Info -->
        <div class="text-center mb-4" id="locationInfo">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Score Display (Static/Non-floating initially) -->
        <div class="row justify-content-center mb-4" id="scoreDisplay">
            <div class="col-md-6">
                <div class="card border-orange shadow-lg">
                    <div class="card-header card-header-orange text-center">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-trophy me-2"></i>
                            Overall Walkability Score
                        </h3>
                    </div>
                    <div class="card-body text-center">
                        <div class="score-circle mx-auto mb-3" id="mainScoreCircle">
                            <span id="scoreValue">--</span>
                        </div>
                        <div id="scoreLabel" class="badge fs-6 mb-2">Calculating...</div>
                        <p class="text-muted mb-0">Based on proximity to essential amenities</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Score (Hidden initially) -->
        <div class="score-floating d-none" id="floatingScore">
            <div class="card border-orange shadow-lg">
                <div class="card-body text-center p-2">
                    <div class="score-circle mx-auto" id="floatingScoreCircle">
                        <span id="floatingScoreValue">--</span>
                    </div>
                    <div class="mt-2 d-none" id="floatingDetails">
                        <div id="floatingScoreLabel" class="badge fs-6 mb-2">--</div>
                        <button class="btn btn-outline-orange btn-sm" onclick="minimizeFloatingScore()">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Map Column -->
            <div class="col-lg-8 mb-4">
                <div class="card border-orange shadow-lg h-100">
                    <div class="card-header card-header-orange">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            Walkability Map
                        </h4>
                    </div>
                    <div class="card-body">
                        <div id="map"></div>
                        <div class="mt-3" id="nearbyPlaces">
                            <h6 class="text-orange-600 mb-3">Nearby Places</h6>
                            <div id="nearbyList">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Column -->
            <div class="col-lg-4">
                <div class="card border-orange shadow-lg mb-4">
                    <div class="card-header card-header-orange">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Category Breakdown
                        </h4>
                    </div>
                    <div class="card-body" id="categoryBreakdown">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <div class="card border-orange shadow-lg">
                    <div class="card-header card-header-orange">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Analysis Details
                        </h4>
                    </div>
                    <div class="card-body" id="analysisDetails">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="app/static/map.js"></script>
    <script>
        let map;
        let floatingVisible = false;
        let floatingExpanded = false;

        // Get score label and badge class
        function getScoreLabel(score) {
            if (score >= 90) return { label: "Walker's Paradise", class: "badge-walker-paradise" };
            if (score >= 70) return { label: "Very Walkable", class: "badge-very-walkable" };
            if (score >= 50) return { label: "Somewhat Walkable", class: "badge-somewhat-walkable" };
            if (score >= 25) return { label: "Car-Dependent", class: "badge-car-dependent" };
            return { label: "Not Walkable", class: "badge-not-walkable" };
        }

        // Format category names
        function formatCategoryName(category) {
            const categoryNames = {
                'metro': 'Metro Stations',
                'bus': 'Bus Stops',
                'grocery': 'Grocery Stores',
                'restaurants': 'Restaurants',
                'parks': 'Parks & Recreation',
                'schools': 'Schools',
                'healthcare': 'Healthcare'
            };
            return categoryNames[category] || category.charAt(0).toUpperCase() + category.slice(1);
        }

        // Get category icon
        function getCategoryIcon(category) {
            const icons = {
                'metro': 'fas fa-subway',
                'bus': 'fas fa-bus',
                'grocery': 'fas fa-shopping-cart',
                'restaurants': 'fas fa-utensils',
                'parks': 'fas fa-tree',
                'schools': 'fas fa-graduation-cap',
                'healthcare': 'fas fa-hospital'
            };
            return icons[category] || 'fas fa-map-marker-alt';
        }

        // Handle scroll for floating score
        function handleScroll() {
            const scrollY = window.scrollY;
            const shouldFloat = scrollY > 200;

            if (shouldFloat && !floatingVisible) {
                showFloatingScore();
            } else if (!shouldFloat && floatingVisible) {
                hideFloatingScore();
            }
        }

        function showFloatingScore() {
            const scoreDisplay = document.getElementById('scoreDisplay');
            const floatingScore = document.getElementById('floatingScore');

            scoreDisplay.style.display = 'none';
            floatingScore.classList.remove('d-none');
            floatingVisible = true;
        }

        function hideFloatingScore() {
            const scoreDisplay = document.getElementById('scoreDisplay');
            const floatingScore = document.getElementById('floatingScore');

            scoreDisplay.style.display = 'block';
            floatingScore.classList.add('d-none');
            floatingVisible = false;
            floatingExpanded = false;
        }

        function toggleFloatingScore() {
            const floatingScore = document.getElementById('floatingScore');
            const floatingDetails = document.getElementById('floatingDetails');

            if (!floatingExpanded) {
                floatingScore.classList.add('expanded');
                floatingDetails.classList.remove('d-none');
                floatingExpanded = true;
            }
        }

        function minimizeFloatingScore() {
            const floatingScore = document.getElementById('floatingScore');
            const floatingDetails = document.getElementById('floatingDetails');

            floatingScore.classList.remove('expanded');
            floatingDetails.classList.add('d-none');
            floatingExpanded = false;
        }

        // Initialize page
        function initializePage() {
            // Get data from sessionStorage
            const resultData = sessionStorage.getItem('walkability_result');

            if (!resultData) {
                document.body.innerHTML = `
                    <div class="container py-5 text-center">
                        <div class="alert alert-warning">
                            <h4>No walkability data found</h4>
                            <p>Please go back and calculate your walkability score first.</p>
                            <a href="/" class="btn btn-orange">Calculate Walkability</a>
                        </div>
                    </div>
                `;
                return;
            }

            const data = JSON.parse(resultData);

            // Update location info
            if (data.center) {
                document.getElementById('locationInfo').innerHTML = `
                    <p class="text-muted lead">
                        Results for your location at 
                        <span class="text-orange-600">${data.center.lat.toFixed(4)}, ${data.center.lon.toFixed(4)}</span>
                    </p>
                `;
            }

            // Update score
            const score = Math.round(data.index || 0);
            const scoreInfo = getScoreLabel(score);

            document.getElementById('scoreValue').textContent = score;
            document.getElementById('floatingScoreValue').textContent = score;

            const scoreLabel = document.getElementById('scoreLabel');
            const floatingScoreLabel = document.getElementById('floatingScoreLabel');

            scoreLabel.textContent = scoreInfo.label;
            scoreLabel.className = `badge fs-6 mb-2 ${scoreInfo.class}`;
            floatingScoreLabel.textContent = scoreInfo.label;
            floatingScoreLabel.className = `badge fs-6 mb-2 ${scoreInfo.class}`;

            // Update category breakdown
            if (data.breakdown) {
                const categoryBreakdown = document.getElementById('categoryBreakdown');
                let breakdownHTML = '';

                data.breakdown.forEach(item => {
                    const percentage = Math.round(item.score * 100);
                    const categoryName = formatCategoryName(item.name);
                    const icon = getCategoryIcon(item.name);

                    breakdownHTML += `
                        <div class="category-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><i class="${icon} me-2"></i>${categoryName}</span>
                                <span class="text-orange-700">${percentage}%</span>
                            </div>
                            <div class="progress progress-orange" style="height: 8px;">
                                <div class="progress-bar" style="width: ${percentage}%"></div>
                            </div>
                            <small class="text-muted">Weight: ${item.weight}</small>
                        </div>
                    `;
                });

                categoryBreakdown.innerHTML = breakdownHTML;
            }

            // Update nearby places
            if (data.nearby) {
                const nearbyList = document.getElementById('nearbyList');
                let nearbyHTML = '';

                data.nearby.forEach(place => {
                    const icon = getCategoryIcon(place.category);
                    nearbyHTML += `
                        <div class="nearby-item">
                            <div class="d-flex align-items-center">
                                <i class="${icon} me-3 icon-orange"></i>
                                <div>
                                    <strong>${place.name}</strong>
                                    <br>
                                    <small class="text-muted">${formatCategoryName(place.category)}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });

                nearbyList.innerHTML = nearbyHTML || '<p class="text-muted">No nearby places found</p>';
            }

            // Update analysis details
            const analysisDetails = document.getElementById('analysisDetails');
            analysisDetails.innerHTML = `
                <div class="score-detail">
                    <h6 class="text-orange-600 mb-3">Analysis Summary</h6>
                    <p class="mb-2"><strong>Overall Score:</strong> ${score}/100</p>
                    <p class="mb-2"><strong>Categories Analyzed:</strong> ${data.breakdown ? data.breakdown.length : 0}</p>
                    <p class="mb-2"><strong>Nearby Places Found:</strong> ${data.nearby ? data.nearby.length : 0}</p>
                    <p class="mb-0"><strong>Search Buffers:</strong> ${data.buffers_m ? data.buffers_m.join('m, ') + 'm' : 'N/A'}</p>
                </div>
            `;

            // Initialize map
            try {
                if (typeof initWalkabilityMap === 'function') {
                    initWalkabilityMap(data);
                } else {
                    // Fallback simple map if map.js not available
                    initSimpleMap(data);
                }
            } catch (error) {
                console.error('Error initializing map:', error);
                initSimpleMap(data);
            }

            // Add scroll listener
            window.addEventListener('scroll', handleScroll);

            // Add click handler for floating score
            document.getElementById('floatingScoreCircle').addEventListener('click', toggleFloatingScore);
        }

        // Fallback simple map initialization
        function initSimpleMap(data) {
            if (data.center) {
                map = L.map('map').setView([data.center.lat, data.center.lon], 15);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);

                // Add center marker
                L.marker([data.center.lat, data.center.lon])
                    .addTo(map)
                    .bindPopup('Your Location');

                // Add nearby places
                if (data.nearby) {
                    data.nearby.forEach(place => {
                        if (place.geometry && place.geometry.coordinates) {
                            const [lon, lat] = place.geometry.coordinates;
                            L.circleMarker([lat, lon], {
                                radius: 6,
                                fillColor: '#f97316',
                                color: '#ea580c',
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.8
                            }).addTo(map).bindPopup(place.name);
                        }
                    });
                }

                // Add buffer circles
                if (data.buffers_m) {
                    data.buffers_m.forEach((buffer, index) => {
                        L.circle([data.center.lat, data.center.lon], {
                            radius: buffer,
                            fillColor: '#f97316',
                            color: '#ea580c',
                            weight: 1,
                            opacity: 0.3,
                            fillOpacity: 0.1
                        }).addTo(map);
                    });
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>

</html>